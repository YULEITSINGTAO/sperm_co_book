{"title":"Data Preparation","markdown":{"headingText":"Data Preparation","containsRefs":false,"markdown":"\n## GATK Genotyping\n\nCalling sperm genotype from fastq files were conducted by [GATK piplines](https://gatk.broadinstitute.org/hc/en-us). This code shows the work after getting the gvcf files. For the blood samples, run whole GATK population SNP calling pipeline and get the vcf file.\n\n## Extract the key features of VCF files\n\nIn order to check the correct filter for detecting the genotype, we study the distribution of vcf features. The first step to do that is use the bcftools to extract the key features of the VCF.\n\n```{r, filename = \"Bash\", eval = FALSE}\n#!/bin/bash -l\n\n### A robust Bash header\n#This option prevents this, by terminating the script if any command exited with a nonzero exit status.\nset -e\nset -u\nset -o pipefail\n###\n\nsperm_sample_nameList=\"../datasets/sperm_sample_namelist/sperm_sample_nameList.tsv\"\n\nfor i in {1..22}\ndo\n        echo \"Filtering chromosome${i}\"\n\n        while read vcf_file; do\n                vcf_input=\"../datasets/sperm_vcf_file/raw_vcf/chr${i}/${vcf_file}.vcf.gz\"\n                vcf_features_output=\"../datasets/sperm_vcf_file/extract_feature_raw_vcf/chr${i}/${vcf_file}.tsv\"\n                bcftools query -f '%CHROM %POS %REF %ALT [%DP %QUAL %QD %FS %SOR %MQRankSum %ReadPosRankSum]\\n' ${vcf_input} > ${vcf_features_output}\n\n        done <${sperm_sample_nameList}\n\ndone\n```\n\n## Read the sperm list\n\nWe extract the sperm sample id and make the table that notes the sperm id and donor id information.\n\n```{r, filename = \"R script\", eval=F}\nsperm_name_list <- data.table::fread(\"../datasets/sperm_sample_namelist/sperm_sample_nameList.tsv\",\n                         header=FALSE) %>% as.data.frame()\n\ncolnames(sperm_name_list) <- \"sperm_ID\"\n\nsperm_name_list <- sperm_name_list %>% dplyr::mutate(donor_ID = gsub(\"s\\\\d+\", \"\", sperm_ID)) %>%\n                    dplyr::mutate(donor_ID = gsub(\"N\", \"NF\", donor_ID)) %>%\n                    dplyr::mutate(donor_ID = gsub(\"NFF\", \"NF\", donor_ID))\n\nfwrite(sperm_name_list, \"../datasets/sperm_sample_namelist/sperm_name_and_donor_nameList.csv\")\n\n\ndonor_name_list <- unique(sperm_name_list$donor_ID)\n\n\n```\n\n## Check the coverage of the VCF files\n\n```{r, filename = \"R script\", eval=F}\n\n## For each sperm, collect the chromosome features from 1 to 22\n\ncollect_all_chr <- function(sperm_name){\n  \n  sperm_directory <- paste0(\"../datasets/sperm_vcf_file/\", c(1:22), \"/\", sperm_name, \".tsv\")\n  \n  all_chromosomes <- lapply(sperm_directory, function(i){\n  fread(i, header=FALSE)\n  })\n  \n  all_chromosomes_df <- do.call(rbind.data.frame, all_chromosomes)\n  \n  colnames(all_chromosomes_df) <- c(\"Chr\", \"Start\", \"DP\", \"QUAL\")\n  \n  all_chromosomes_df <- all_chromosomes_df %>% dplyr::mutate(End = Start) %>% \n                        mutate_at(c(\"Start\", \"End\", \"DP\", \"QUAL\"), as.numeric)\n  \n  \n  all_chromosomes_df <- all_chromosomes_df[, c(\"Chr\", \"Start\", \"End\", \"DP\", \"QUAL\")]\n  \n  \n  all_chromosomes_df <- all_chromosomes_df %>% dplyr::filter(DP != 0)\n  \n  all_chromosomes_DF_GR <- toGRanges(all_chromosomes_df)\n  \n  return(all_chromosomes_DF_GR)\n}\n\ncollect_all_sperm <- function(donor_name, sperm_name_list){\n  \n  sub_sperm_name_list <- sperm_name_list %>% dplyr::filter(donor_ID == donor_name)\n  \n  sperm_feature_list <- lapply(sub_sperm_name_list$sperm_ID, collect_all_chr)\n  \n  names(sperm_feature_list) <- sub_sperm_name_list$sperm_ID\n    \n  return(sperm_feature_list)\n                               \n}\n\n## make_SNP_density_plot \ncolor_panel <- c(\"#ddaacc\", \"#0094ff\", \"#ff9200\", \"#008d00\", \"#fb6f66\")\n\nfor (i in donor_name_list) {\n    \n    sperm_feature_list <- collect_all_sperm(i, sperm_name_list)\n    \n    pp <- getDefaultPlotParams(plot.type = 4)\n    pp$data1inmargin <- 0\n    pp$bottommargin <- 20\n    \n    pdf(paste0(\"../figures/figure_coverage_density_plot/\",\n               i, \".pdf\"), \n        width=22, \n        height=5)\n    \n    kp <- karyoploteR::plotKaryotype(genome=\"hg38\", plot.type=4, ideogram.plotter = NULL,\n                    labels.plotter = NULL, plot.params = pp,\n                    main= paste0(\"SNP Density Plot of Donor:\", i), \n                    chromosomes = paste0(\"chr\", c(1:22)))\n    \n    karyoploteR::kpAddCytobandsAsLine(kp)\n    karyoploteR::kpAddChromosomeNames(kp, srt=45)\n    \n    region_vector <- seq(0,1,length.out = length(sperm_feature_list) + 1)\n      \n    for (j in c(1:length(sperm_feature_list))) {\n      karyoploteR::kpPlotDensity(kp, sperm_feature_list[[j]], window.size = 10e4, col=color_panel[j], r0=region_vector[j],\n                    r1=region_vector[j + 1])\n      karyoploteR::kpAddLabels(kp, labels=names(sperm_feature_list)[j], data.panel = 1, r0=region_vector[j],\n                  r1=region_vector[j + 1])\n    }\n    dev.off()\n  }\n  \n```\n\n## Check the Distribution of VCF Features\n\nIn the gvcf files, we have the key features\n\n```{r, filename = \"R script\", eval=F}\n\ncollect_all_chr_features <- function(sperm_name){\n  \n  sperm_directory <- paste0(\"../datasets/sperm_vcf_file/extract_feature/chr\", c(1:22), \"/\", sperm_name, \".tsv\")\n  \n  all_chromosomes <- lapply(sperm_directory, function(i){\n  fread(i, header=FALSE)\n  })\n  \n  all_chromosomes_df <- do.call(rbind.data.frame, all_chromosomes)\n  \n  colnames(all_chromosomes_df) <- c(\"Chr\", \"Start\", \"DP\", \"QUAL\", \"QD\", \"FS\", \"SOR\", \"MQRankSum\", \"ReadPosRankSum\")\n  \n  all_chromosomes_df <- all_chromosomes_df %>% dplyr::mutate(End = Start) %>% \n                        mutate_at(c(\"Start\", \"End\", \"DP\", \"QUAL\", \"QD\", \"FS\", \"SOR\", \"MQRankSum\", \"ReadPosRankSum\"), as.numeric)\n  \n  \n  all_chromosomes_df <- all_chromosomes_df[, c(\"Chr\", \"Start\", \"End\", \"DP\", \"QUAL\", \"QD\", \"FS\", \"SOR\", \"MQRankSum\", \"ReadPosRankSum\")]\n  \n  \n  all_chromosomes_df <- all_chromosomes_df %>% dplyr::filter(DP != 0)\n  \n  return(all_chromosomes_df)\n}\n\n\ncollect_all_sperm_features <- function(donor_name, sperm_name_list){\n  \n  sub_sperm_name_list <- sperm_name_list %>% dplyr::filter(donor_ID == donor_name)\n  \n  sperm_feature_list <- lapply(sub_sperm_name_list$sperm_ID, collect_all_chr_features)\n  \n  names(sperm_feature_list) <- sub_sperm_name_list$sperm_ID\n    \n  return(sperm_feature_list)\n                               \n}\n\n\nfor (i in donor_name_list) {\n  \n  donor <- collect_all_sperm_features(i, sperm_name_list)\n  \n  donor <- dplyr::bind_rows(donor, .id = \"sperm_ID\")\n  \n  donor <- donor %>% dplyr::select(-c(Chr, Start, End))\n  \n  donor <- melt(donor, id=c(\"sperm_ID\"))\n  \n \n  \n  # Density plot in ggplot2\n  \n  ggplot(donor, aes(x = value)) + geom_density(color = 4, fill = 4, alpha = 0.25) + \n    theme_bw() + \n    theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) + \n    facet_grid(vars(sperm_ID), vars(variable), scales = \"free\")\n  \n  ggsave(paste0(\"../figures/figure_coverage_density_plot/\",\n               i, \".pdf\"), \n        width=14, \n        height=10)\n\n}\n\n```\n\n## Filter the vcf file\n\nBased on the raw gvcf file, we use the \"(QUAL\\>10) \\|\\| (ALT=\".\"&FMT/RGQ\\>50)\" to filter the genotypes. This procedure was conducted by bcftools.\n\n```{r, filename = \"bash script\", eval=F}\nsperm_sample_nameList=\"../datasets/sperm_sample_namelist/sperm_sample_nameList.tsv\"\n\n        echo \"Extract VCF: QUAL_and_no_ALT\"\n\n\n        for i in chr{1..22}\n        do\n                echo \"chr: ${i}\"\n\n                while read vcf_file; do\n\n                        vcf_input=\"../datasets/sperm_vcf_file/raw_vcf/chr${i}/${vcf_file}.vcf.gz\"\n                        vcf_output=\"../datasets/sperm_vcf_file/selected_vcf/QUAL_and_RGQ/chr${i}/${vcf_file}.vcf.gz\"\n\n                        #echo \"vcf input directory: ${vcf_input}\"\n                        #echo \"vcf output directory: ${vcf_output}\"\n\n\n                        bcftools view -O z -o ${vcf_output} -i '(QUAL>10) || (ALT=\".\"&FMT/RGQ>50)' ${vcf_input}\n\n\n                done <${sperm_sample_nameList}\n        done\n\n\n```\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"section_1_data_process.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.555","bibliography":["references.bib"],"editor":"visual","theme":"cosmo"},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"section_1_data_process.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"block-headings":true,"bibliography":["references.bib"],"editor":"visual","documentclass":"scrreprt"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf"]}