{"title":"Prepare the input data for HAPI","markdown":{"headingText":"Prepare the input data for HAPI","containsRefs":false,"markdown":"\nFollowed by the last Chapter, we get the filtered SNP positions and next we need to make the sperm VCF files into a R matrix for Hapi. Since genotype phasing and crossover detect only needs heterzygous loci as input, we use the blood sample to get this information then combine with the corresponding positions in sperm to get the matrix.\n\n## Prepare the aneuploidy removed sperm name list\n\n## Generate the Hpai input matrix\n\n```{r, filename = \"R script\", eval = FALSE}\n\nchr_id <- 1\n\nblood_gt_chr <- readRDS(paste0(\"../datasets/simplified_blood_gt_by_chr/simplified_blood_gt_by_chr\", chr_id, \".rds\"))\n\nSPERM_DIRECTORY <- paste0(\"../datasets/sperm_vcf_file/selected_vcf/QUAL_and_RGQ/chr\", chr_id, \"/\")\n\n\nsperm_list <- list.files(path = SPERM_DIRECTORY, pattern = \"*.vcf.gz$\", all.files = FALSE, \n                              full.names = FALSE, recursive = FALSE,\n                              ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)\n\nsperm_list_df <- gsub(\"\\\\.vcf\\\\.gz\", \"\", sperm_list)  \nsperm_list_df <- as.data.frame(sperm_list_df)\n\n#write.table(sperm_list_df, \n#            file = \"D:/sperm_project/sperm_vcf_file/sperm_sampleList/sperm_sample_nameList.tsv\", \n#            append = F, sep = \"\\t\", row.names=FALSE, col.names=FALSE, quote=FALSE)\n\n\n\n## Merge to the matrix\n\npatient_name <- gsub(\"s\\\\d\\\\.vcf\\\\.gz\", \"\", sperm_list)\npatient_name <- unique(patient_name)\n\nfor (chr_id in c(1:22)) {\n  ## Print the current working chrosome\n  \n  print(\"Chromosome:\")\n  print(chr_id)\n  \n  ## Read the blood genotype by chromosome\n  blood_gt_chr <- readRDS(paste0(\"../datasets/simplified_blood_gt_by_chr/simplified_blood_gt_by_chr\", chr_id, \".rds\"))\n  \n  ## The Directory of filter sperm vcf file\n  Filtered_SPERM_DIRECTORY <- paste0(\"../datasets/sperm_vcf_file/selected_vcf/QUAL_and_RGQ/chr\", chr_id, \"/\")\n  \n  ## Initate the Hapi Input Matirx List\n  \n  Hapi_input_matrix_List <- list()\n  \n  for (patient in patient_name) {\n    \n    patient_sperm <- sperm_list[grepl(paste0(patient, \"s\\\\d\"), sperm_list)]\n    \n    sperm_vcf_list <- list()\n    \n    for (sperm_vcf_file in patient_sperm) {\n      \n      vcf_file <- read.vcfR(paste0(Filtered_SPERM_DIRECTORY, sperm_vcf_file), verbose = FALSE)\n      vcf_file_fix_gt <- as.data.frame(extract.gt(vcf_file, as.numeric = T, IDtoRowNames = T)) %>% tibble::rownames_to_column(\"POS\")\n      \n      sperm_id <- gsub(\"\\\\.vcf\\\\.gz\", \"\", sperm_vcf_file)\n      sperm_vcf_list[[sperm_id]] <- vcf_file_fix_gt\n    }\n    \n    sperm_matrix <- sperm_vcf_list %>% reduce(full_join, by = c(\"POS\"))\n    sperm_matrix <- sperm_matrix %>% separate(POS, c('chr', 'pos'))\n    sperm_matrix <- sperm_matrix[-1]\n    sperm_matrix <- sperm_matrix %>% mutate_if(is.character, as.integer)\n    \n    ## change NF patient name\n    \n    patient<- gsub(\"N\", \"NF\", patient)\n    patient<- gsub(\"NFF\", \"NF\", patient)\n    \n    blood_patient_gt <- blood_gt_chr[ , c(\"chr\", \"pos\", \"ref\", \"alt\", patient)]\n    blood_patient_het_gt <- blood_patient_gt[str_detect(blood_patient_gt[,5], \"0/1|0\\\\|1\"), ]\n    rownames(blood_patient_het_gt) <- blood_patient_het_gt$pos\n    \n    rownames(sperm_matrix) <- sperm_matrix$pos\n    common_position <- intersect(rownames(sperm_matrix), rownames(blood_patient_het_gt))\n    \n    hapi_input_matrix <- cbind(blood_patient_het_gt[common_position, -5], sperm_matrix[common_position, -c(1)])\n    \n    sorted_hapi_input_matrix <- hapi_input_matrix[order(hapi_input_matrix$pos),]\n    \n    Hapi_input_matrix_List[[patient]] <- sorted_hapi_input_matrix\n    \n  }  \n  \n  saveRDS(Hapi_input_matrix_List, paste0(\"../datasets/Hapi_input/QUAL_and_RGQ/chr\", chr_id, \".rds\"))\n}\n\n```\n\n## Remove the aneuploidy sperms\n\n## Remove the aneuploidy\n\n```{r, filename = \"R script\", eval = FALSE}\n\naneuploidy_sperm_list <- c(\"AS24s5\", \"AS32s4\", \"NF25-1s1\", \"NF27-3s3\")\naneuploidy_donor_list <- c(\"AS24\", \"AS32\", \"NF25-1\", \"NF27-3\")\n\nNA_count_chr_list <- list()  \n\nfor (chr_id in c(1:22)) {\n  Hapi_input <- readRDS(paste0(\"../datasets/Hapi_input/QUAL_and_RGQ/chr\", chr_id, \".rds\"))\n  \n  for (donor in aneuploidy_donor_list) {\n    colnames(Hapi_input[[donor]]) <- gsub(\"N\", \"NF\", colnames(Hapi_input[[donor]]))\n    colnames(Hapi_input[[donor]]) <- gsub(\"NFF\", \"NF\", colnames(Hapi_input[[donor]]))\n    \n    Hapi_input[[donor]] <- Hapi_input[[donor]][,!names(Hapi_input[[donor]]) %in% aneuploidy_sperm_list]\n  }\n  \n  NA_count_chr <- c()\n  \n  for (donor in names(Hapi_input)) {\n    \n    colnames(Hapi_input[[donor]]) <- gsub(\"N\", \"NF\", colnames(Hapi_input[[donor]]))\n    colnames(Hapi_input[[donor]]) <- gsub(\"NFF\", \"NF\", colnames(Hapi_input[[donor]]))\n    \n    NA_count <- t(Hapi_input[[donor]] %>% dplyr::select(-c(chr, pos, ref, alt)) %>% summarise_all(~sum(is.na(.))))/nrow(Hapi_input[[donor]])\n    NA_count_chr <- rbind(NA_count_chr, NA_count)\n    \n  }\n  \n  saveRDS(Hapi_input, paste0(\"../datasets/Hapi_input/QUAL_and_RGQ_aneu_removed/chr\", chr_id, \".rds\"))\n  \n  colnames(NA_count_chr) <- paste0(\"chr\", chr_id)\n  \n  NA_count_chr_list[[paste0(\"chr\", chr_id)]] <- NA_count_chr\n  \n  \n}\n\nsaveRDS(NA_count_chr_list, paste0(\"../datasets/Hapi_input/QUAL_and_RGQ_aneu_removed/NA_count_chr_list.rds\"))\n```\n## Check the NA density\n\n```{r, filename = \"R script\", eval = FALSE}\nNA_count_chr_list <- readRDS(\"../datasets/Hapi_input/QUAL_and_RGQ_aneu_removed/NA_count_chr_list.rds\")\n  \nNA_count_chr <- do.call(cbind, NA_count_chr_list)\nrownames(NA_count_chr) <- gsub(\"N\", \"NF\", rownames(NA_count_chr))\nrownames(NA_count_chr) <- gsub(\"NFF\", \"NF\", rownames(NA_count_chr))\n\nNA_count_chr <- NA_count_chr %>% as.data.frame() %>% tibble::rownames_to_column(\"sperm_id\") %>% \n  dplyr::mutate(Individual = gsub(\"s\\\\d+\", \"\", sperm_id), Type = ifelse(grepl(\"AS\", Individual), \"AS\", \"NF\"))\n\nNA_count_chr <- melt(NA_count_chr, id=c(\"sperm_id\", \"Individual\", \"Type\"))\n\nggplot(NA_count_chr, aes(x=value, color=Type)) +\n  geom_density() + theme_bw() + \n  scale_color_manual(values=c(\"coral\", \"cornflowerblue\")) + \n  facet_grid( variable ~ .)\n\nggsave(paste0(\"../figures/QUAL_and_RGQ_aneu_removed_NA_Density.pdf\"), width = 8, height = 22*3, limitsize = FALSE)\n\nNA_count_chr <- do.call(cbind, NA_count_chr_list)\nrownames(NA_count_chr) <- gsub(\"N\", \"NF\", rownames(NA_count_chr))\nrownames(NA_count_chr) <- gsub(\"NFF\", \"NF\", rownames(NA_count_chr))\nNA_count_chr <- NA_count_chr %>% as.data.frame() %>% tibble::rownames_to_column(\"sperm_id\")\n\nNA_count_chr$larger_07_count <- rowSums(NA_count_chr[, -1] > 0.7, na.rm=FALSE)\n\nremove_by_NA_sperm_list <- NA_count_chr$sperm_id[NA_count_chr$larger_07_count > 2]\n\nsaveRDS(remove_by_NA_sperm_list, \"../datasets/Hapi_input/QUAL_and_RGQ_aneu_removed/remove_by_NA_sperm_list.rds\")\n```\n\n## Regenerate the Hapi input\n\n```{r, filename = \"R script\", eval = FALSE}\n\nfor (chr_id in c(1:22)) {\n  Hapi_input <- readRDS(paste0(\"../datasets/Hapi_input/QUAL_and_RGQ_aneu_removed/chr\", chr_id, \".rds\"))\n  \n  for (donor in names(Hapi_input)) {\n    \n    colnames(Hapi_input[[donor]]) <- gsub(\"N\", \"NF\", colnames(Hapi_input[[donor]]))\n    colnames(Hapi_input[[donor]]) <- gsub(\"NFF\", \"NF\", colnames(Hapi_input[[donor]]))\n    \n    Hapi_input[[donor]] <- Hapi_input[[donor]][,!names(Hapi_input[[donor]]) %in% remove_by_NA_sperm_list]\n    \n  }\n  saveRDS(Hapi_input, paste0(\"D:/sperm_project/Hapi_input/QUAL_and_RGQ_aneu_NA_removed_3/chr\", chr_id, \".rds\"))\n}\n\n```\n\n## Count the sperm number in each individual after filter\n\n```{r, filename = \"R script\", eval = FALSE}\nsperms_count <- c()\n\nHapi_input <- readRDS(paste0(\"../datasets/Hapi_input/QUAL_and_RGQ_aneu_NA_removed_3/chr\", 1, \".rds\"))\n\nfor (donor in names(Hapi_input)) {\n  \n    sperms_count <- c(sperms_count, ncol(Hapi_input[[donor]]) - 4)\n    \n}\n\nnames(sperms_count) <- names(Hapi_input)\n\nremove_donor <- names(sperms_count[sperms_count < 3])\n\nsaveRDS(remove_donor, \"../datasets/Hapi_input/QUAL_and_RGQ_aneu_NA_removed_3/remove_donor.rds\")\n\n\nfor (chr_id in c(1:22)) {\n  \n  Hapi_input <- readRDS(paste0(\"../datasets/Hapi_input/QUAL_and_RGQ_aneu_NA_removed_3/chr\", chr_id, \".rds\"))\n  \n  for (donor in remove_donor) {\n    \n    Hapi_input[[donor]] <- NULL\n    \n  }\n  saveRDS(Hapi_input, paste0(\"../datasets/Hapi_input/QUAL_and_RGQ_aneu_NA_removed_3/chr\", chr_id, \".rds\"))\n}\n  \n```\n\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"section_3_prepare_data_for_Hapi.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.450","bibliography":["references.bib"],"editor":"visual","theme":"cosmo"},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"section_3_prepare_data_for_Hapi.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"block-headings":true,"bibliography":["references.bib"],"editor":"visual","documentclass":"scrreprt"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf"]}